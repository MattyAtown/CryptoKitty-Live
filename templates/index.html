<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CryptoKitty Elite v2.2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">// Update the chart on every price fetch
function updateChart() {
  const datasets = Array.from(selectedCoins).map(coin => {
    const prices = priceHistory[coin] || [];
    if (prices.length === 0) return null;

    // Calculate percentage changes for the chart
    const basePrice = prices[0] || 1;
    const percentChanges = prices.map(p => ((p - basePrice) / basePrice) * 100);

    return {
      label: coin,
      data: percentChanges,
      borderColor: "#" + Math.floor(Math.random() * 16777215).toString(16),
      pointRadius: 3,
      borderWidth: 2,
      fill: false,
      tension: 0.3
    };
  }).filter(Boolean);

  // Update the chart data
  priceChart.data.datasets = datasets;
  priceChart.update();
}

// Fetch prices on load to populate the chart initially
fetchPrices();
updateChart();

</script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="/static/cryptokitty.css">
</head>

<body>
<div class="main-wrapper">
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="cryptoDogToggle" onclick="toggleCryptoDog()">üê∂ CryptoDog</div>
    <h1>üê± CryptoKitty Elite Tracker</h1>
    <div class="top-right-logo">
      <img src="/static/logo.png" alt="Logo" />
    </div>
  </div>

  <!-- Flashing Banner -->
  <div class="alert-banner" id="alertBanner">
    <div id="newsTicker" class="news-ticker">Loading news...</div>
  </div>

  <!-- 4-Panel Layout -->
  <div class="content-row">
    <div class="panel coins-panel">
      <h2>Select Coins</h2>
      <select id="coinSelector" multiple size="10"></select><br><br>
      <button id="updateButton">Update</button>
    </div>

    <div class="panel prices-panel">
      <h2>üìà Prices & Change</h2>
      <ul id="pricesList"></ul>
      <h3>üöÄ Top Risers</h3>
      <ul id="topRisersList"></ul>
    </div>

    <div class="panel cryptodog-panel">
      <h2>üê∂ CryptoDog</h2>
      <div id="cryptoDogWidget" class="cryptodog-widget" style="display: none;">
        <img id="dogImage" src="/static/neutral.png" alt="Dog Face" />
        <div id="cryptoDogAlerts" class="dog-alerts"></div>
      </div>
    </div>

    <div class="panel chart-panel">
      <h2>üìä Live Chart</h2>
      <canvas id="priceChart"></canvas>
    </div>
  </div>
</div>

<script>
const defaultCoins = ["BTC", "ETH", "XRP", "SOL", "ADA", "DOGE", "MATIC", "DOT"];
const coinSelector = document.getElementById('coinSelector');
const selectedCoins = new Set();
const priceHistory = {};

// Populate the coin selector
defaultCoins.forEach(coin => {
  const option = document.createElement('option');
  option.value = coin;
  option.textContent = coin;
  coinSelector.appendChild(option);
});

// Double-click to select/deselect coins
coinSelector.addEventListener('dblclick', (e) => {
  const coin = e.target.value;
  if (selectedCoins.has(coin)) {
    selectedCoins.delete(coin);
  } else {
    selectedCoins.add(coin);
  }
  console.log("Selected Coins:", Array.from(selectedCoins));
  fetchPrices();
  updateChart();
});

// Fetch live prices and update top risers
function fetchPrices() {
  const selectedCoinArray = Array.from(selectedCoins);
  if (selectedCoinArray.length === 0) {
    alert("Please select at least one coin.");
    return;
  }

  fetch('/api/price-history')
    .then(response => response.json())
    .then(data => {
      const pricesList = document.getElementById('pricesList');
      const topRisersList = document.getElementById('topRisersList');
      pricesList.innerHTML = '';
      topRisersList.innerHTML = '';

      selectedCoinArray.forEach(coin => {
        const history = data[coin] || [];
        if (!priceHistory[coin]) priceHistory[coin] = [];
        priceHistory[coin] = history;

        const currentPrice = history[history.length - 1] || 0;
        pricesList.innerHTML += `<li>${coin}: $${currentPrice}</li>`;

        const lastThree = history.slice(-3);
        if (lastThree.length === 3 && lastThree[2] > lastThree[1] && lastThree[1] > lastThree[0]) {
          const percentChange = ((lastThree[2] - lastThree[0]) / lastThree[0] * 100).toFixed(2);
          topRisersList.innerHTML += `<li>${coin}: +${percentChange}%</li>`;
        }
      });
    })
    .catch(error => console.error("Error fetching prices:", error));
}

// Initialize the chart
const ctx = document.getElementById('priceChart').getContext('2d');
const priceChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({ length: 10 }, (_, i) => (9 - i) * 5 + ' min ago'),
    datasets: []
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: false,
        title: {
          display: true,
          text: '% Change'
        },
        ticks: {
          callback: value => value.toFixed(1) + '%'
        }
      }
    },
    plugins: {
      legend: {
        labels: {
          color: '#fff'
        }
      }
    }
  }
});

// Update the chart on every price fetch
function updateChart() {
  const datasets = Array.from(selectedCoins).map(coin => {
    const prices = priceHistory[coin] || [];
    if (prices.length === 0) return null;

    const basePrice = prices[0];
    const percentChanges = prices.map(p => ((p - basePrice) / basePrice) * 100);

    return {
      label: coin,
      data: percentChanges,
      borderColor: "#" + Math.floor(Math.random() * 16777215).toString(16),
      pointRadius: 3,
      borderWidth: 2,
      fill: false,
      tension: 0.3
    };
  }).filter(Boolean);

  priceChart.data.datasets = datasets;
  priceChart.update();
}

</script>
</body>
</html>
